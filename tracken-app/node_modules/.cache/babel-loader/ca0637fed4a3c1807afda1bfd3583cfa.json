{"ast":null,"code":"import _defineProperty from \"/home/vlad/Desktop/repos/jfdd11-nan-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _objectSpread from \"/home/vlad/Desktop/repos/jfdd11-nan-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _classCallCheck from \"/home/vlad/Desktop/repos/jfdd11-nan-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/home/vlad/Desktop/repos/jfdd11-nan-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/home/vlad/Desktop/repos/jfdd11-nan-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/home/vlad/Desktop/repos/jfdd11-nan-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/home/vlad/Desktop/repos/jfdd11-nan-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/home/vlad/Desktop/repos/jfdd11-nan-app/src/components/Chat/Apps.js\";\nimport React, { Component } from \"react\";\nimport \"./Apps.css\";\nimport Form from \"../Chat/Form.js\";\nimport { Dropdown, Menu } from 'semantic-ui-react';\nimport firebase from \"firebase\";\nimport MainMenu from \"../MainMenu\";\nimport { withAuth } from \"../../contexts/AuthContext\";\nimport moment from \"moment\";\n\nvar Apps =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(Apps, _Component);\n\n  function Apps() {\n    var _getPrototypeOf2;\n\n    var _this;\n\n    _classCallCheck(this, Apps);\n\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    _this = _possibleConstructorReturn(this, (_getPrototypeOf2 = _getPrototypeOf(Apps)).call.apply(_getPrototypeOf2, [this].concat(args)));\n    _this.state = {\n      user: null,\n      adminIds: null,\n      users: null,\n      currentChatId: null\n    };\n\n    _this.readAdmins = function (snapshot) {\n      _this.setState({\n        adminIds: Object.keys(snapshot.val() || {})\n      });\n    };\n\n    _this.readUsers = function (snapshot) {\n      _this.setState({\n        users: snapshot.val()\n      });\n    };\n\n    _this.readChats = function (snapshot) {\n      _this.setState({\n        chats: snapshot.val()\n      });\n    };\n\n    _this.getChats = function () {\n      var _this$state = _this.state,\n          chats = _this$state.chats,\n          users = _this$state.users;\n      var user = _this.props.authContext.user;\n\n      if (!chats || !users || !user) {\n        return [];\n      }\n\n      var chatIdsAsObject = _this.state.users[user.uid].chatIds;\n      var chatIdsAsArray = Object.keys(chatIdsAsObject || {});\n      var presentedChats = chatIdsAsArray.map(function (chatId) {\n        if (chatId) {\n          return _objectSpread({}, chats[chatId], {\n            id: chatId\n          });\n        } else {\n          return null;\n        }\n      }).filter(function (chat) {\n        return chat !== null;\n      }).filter(function (chat) {\n        var firstUserId = chat.firstUserId,\n            secondUserId = chat.secondUserId;\n        var loggedInUserId = user.uid;\n        return firstUserId !== loggedInUserId || secondUserId !== loggedInUserId;\n      }).map(function (chat) {\n        var firstUserId = chat.firstUserId,\n            secondUserId = chat.secondUserId;\n        var loggedInUserId = user.id;\n        return {\n          chatId: chat.id,\n          userName: loggedInUserId === firstUserId ? users[secondUserId].name : users[firstUserId].name\n        };\n      });\n      return presentedChats;\n    };\n\n    _this.startChat = function (chatBuddyId) {\n      var _updates;\n\n      var myId = _this.props.authContext.user && _this.props.authContext.user.uid;\n\n      if (myId === null || chatBuddyId === null) {\n        return;\n      }\n\n      var chatId = firebase.database().ref(\"chats\").push().key;\n      var updates = (_updates = {}, _defineProperty(_updates, \"/chats/\".concat(chatId), {\n        firstUserId: myId,\n        secondUserId: chatBuddyId\n      }), _defineProperty(_updates, \"/users/\".concat(myId, \"/chatIds/\").concat(chatId), true), _defineProperty(_updates, \"/users/\".concat(chatBuddyId, \"/chatIds/\").concat(chatId), true), _defineProperty(_updates, \"createdAt\", firebase.database.ServerValue.TIMESTAMP), _updates);\n      firebase.database().ref().update(updates);\n\n      _this.setState({\n        currentChatId: chatId\n      });\n    };\n\n    return _this;\n  }\n\n  _createClass(Apps, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      firebase.database().ref(\"admins\").on(\"value\", this.readAdmins);\n      firebase.database().ref(\"users\").on(\"value\", this.readUsers);\n      firebase.database().ref(\"chats\").on(\"value\", this.readChats);\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      firebase.database().ref(\"admins\").off(\"value\", this.readAdmins);\n      firebase.database().ref(\"users\").off(\"value\", this.readUsers);\n      firebase.database().ref(\"users\").off(\"value\", this.readChats);\n    }\n  }, {\n    key: \"handleSignIn\",\n    value: function handleSignIn() {\n      var _this2 = this;\n\n      firebase.auth().signInWithEmailAndPassword().then(function (data) {\n        _this2.setState({\n          error: null,\n          success: \"Sign in successful\"\n        });\n      }).catch(function (error) {\n        return _this2.setState({\n          error: error,\n          success: null\n        });\n      });\n    }\n  }, {\n    key: \"handleLogOut\",\n    value: function handleLogOut() {\n      firebase.auth().signOut();\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this3 = this;\n\n      var users = this.state.adminIds && this.state.adminIds.map(function (userId) {\n        return _this3.state.users && _this3.state.users[userId] && _objectSpread({\n          id: userId\n        }, _this3.state.users[userId]);\n      }).filter(function (user) {\n        return user === undefined || user === null ? false : true;\n      });\n      return React.createElement(\"div\", {\n        className: \"app\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 167\n        },\n        __self: this\n      }, React.createElement(\"div\", {\n        className: \"mainMenuChat\",\n        style: {\n          width: \"100%\",\n          background: \"#eee\"\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 168\n        },\n        __self: this\n      }, React.createElement(MainMenu, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 172\n        },\n        __self: this\n      })), React.createElement(\"div\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 174\n        },\n        __self: this\n      }, React.createElement(\"h1\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 175\n        },\n        __self: this\n      }, \"Welcome to Tracken Chat\"), React.createElement(\"ul\", {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 176\n        },\n        __self: this\n      }, users && users.map(function (user) {\n        return React.createElement(\"li\", {\n          key: user.id,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 179\n          },\n          __self: this\n        }, React.createElement(\"button\", {\n          className: \"ui button active\",\n          onClick: function onClick() {\n            return _this3.startChat(user.id);\n          },\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 181\n          },\n          __self: this\n        }, \"Start Chat with Admin \"));\n      }))), React.createElement(\"div\", {\n        className: \"app__list\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 189\n        },\n        __self: this\n      }, React.createElement(Menu, {\n        horizontal: \"true\",\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 190\n        },\n        __self: this\n      }, React.createElement(Dropdown, {\n        item: true,\n        text: this.state.currentChatUserName,\n        style: {\n          textAlign: \"center\"\n        },\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 191\n        },\n        __self: this\n      }, React.createElement(Dropdown.Menu, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 194\n        },\n        __self: this\n      }, this.props.authContext.user && this.state.users && this.getChats().map(function (chat) {\n        return React.createElement(Dropdown.Item, {\n          key: chat.chatId,\n          onClick: function onClick() {\n            return _this3.setState({\n              currentChatId: chat.chatId,\n              currentChatUserName: chat.userName\n            });\n          },\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 197\n          },\n          __self: this\n        }, chat.userName, \",\", moment(new Date().getTime()));\n      })))), this.state.currentChatId && React.createElement(Form, {\n        user: this.props.authContext.user,\n        users: this.state.users,\n        key: this.state.currentChatId,\n        chatId: this.state.currentChatId,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 207\n        },\n        __self: this\n      })));\n    }\n  }]);\n\n  return Apps;\n}(Component);\n\nexport default withAuth(Apps);","map":{"version":3,"sources":["/home/vlad/Desktop/repos/jfdd11-nan-app/src/components/Chat/Apps.js"],"names":["React","Component","Form","Dropdown","Menu","firebase","MainMenu","withAuth","moment","Apps","state","user","adminIds","users","currentChatId","readAdmins","snapshot","setState","Object","keys","val","readUsers","readChats","chats","getChats","props","authContext","chatIdsAsObject","uid","chatIds","chatIdsAsArray","presentedChats","map","chatId","id","filter","chat","firstUserId","secondUserId","loggedInUserId","userName","name","startChat","chatBuddyId","myId","database","ref","push","key","updates","ServerValue","TIMESTAMP","update","on","off","auth","signInWithEmailAndPassword","then","data","error","success","catch","signOut","userId","undefined","width","background","currentChatUserName","textAlign","Date","getTime"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport \"./Apps.css\";\nimport Form from \"../Chat/Form.js\";\nimport { Dropdown, Menu } from 'semantic-ui-react'\nimport firebase from \"firebase\";\nimport MainMenu from \"../MainMenu\";\nimport { withAuth } from \"../../contexts/AuthContext\";\nimport moment from \"moment\";\n\n\nclass Apps extends Component {\n  state = {\n    user: null,\n    adminIds: null,\n    users: null,\n    currentChatId: null\n  };\n\n  readAdmins = snapshot => {\n    this.setState({\n      adminIds: Object.keys(snapshot.val() || {})\n    });\n  };\n\n  readUsers = snapshot => {\n    this.setState({\n      users: snapshot.val()\n    });\n  };\n\n  readChats = snapshot => {\n    this.setState({\n      chats: snapshot.val()\n    })\n  }\n\n  getChats = () => {\n    const { chats, users } = this.state\n    const user = this.props.authContext.user\n    if (!chats || !users || !user) {\n      return []\n    }\n\n    const chatIdsAsObject = this.state.users[user.uid].chatIds\n    const chatIdsAsArray = Object.keys(chatIdsAsObject || {})\n\n    const presentedChats = chatIdsAsArray\n      .map(chatId => {\n        if (chatId) {\n          return {\n            ...chats[chatId],\n            id: chatId\n          }\n        } else {\n          return null\n        }\n      })\n      .filter(chat => chat !== null)\n      .filter(chat => {\n        const { firstUserId, secondUserId } = chat\n        const loggedInUserId = user.uid\n        \n        return firstUserId !== loggedInUserId || secondUserId !== loggedInUserId \n      })\n      .map(chat => {\n        const { firstUserId, secondUserId } = chat\n        const loggedInUserId = user.id\n        return {\n          chatId: chat.id,\n          userName: loggedInUserId === firstUserId ? users[secondUserId].name : users[firstUserId].name \n        }\n      })\n\n    return presentedChats\n  }\n\n  componentDidMount() {\n    \n    firebase\n      .database()\n      .ref(\"admins\")\n      .on(\"value\", this.readAdmins);\n    firebase\n      .database()\n      .ref(\"users\")\n      .on(\"value\", this.readUsers);\n    firebase\n      .database()\n      .ref(\"chats\")\n      .on(\"value\", this.readChats)\n  }\n\n  componentWillUnmount() {\n    firebase\n      .database()\n      .ref(\"admins\")\n      .off(\"value\", this.readAdmins);\n    firebase\n      .database()\n      .ref(\"users\")\n      .off(\"value\", this.readUsers);\n    firebase\n      .database()\n      .ref(\"users\")\n      .off(\"value\", this.readChats);\n  }\n\n  startChat = chatBuddyId => {\n    const myId = this.props.authContext.user && this.props.authContext.user.uid;\n\n    if (myId === null || chatBuddyId === null) {\n      return;\n    }\n\n    const chatId = firebase\n      .database()\n      .ref(\"chats\")\n      .push().key;\n\n    const updates = {\n      [`/chats/${chatId}`]: {\n        firstUserId: myId,\n        secondUserId: chatBuddyId,\n       \n      },\n      [`/users/${myId}/chatIds/${chatId}`]: true,\n      [`/users/${chatBuddyId}/chatIds/${chatId}`]: true,\n      createdAt: firebase.database.ServerValue.TIMESTAMP,\n    }\n    \n    firebase\n      .database()\n      .ref().update(updates)\n\n    this.setState({\n      currentChatId: chatId\n    });\n  };\n\n  handleSignIn() {\n    firebase\n      .auth()\n      .signInWithEmailAndPassword()\n      .then(data => {\n        this.setState({ error: null, success: \"Sign in successful\" });\n      })\n      .catch(error => this.setState({ error: error, success: null }));\n  }\n  handleLogOut() {\n    firebase.auth().signOut();\n  }\n  render() {\n    const users =\n      this.state.adminIds &&\n      this.state.adminIds\n        .map(\n          userId =>\n            this.state.users &&\n            this.state.users[userId] && {\n              id: userId,\n              ...this.state.users[userId]\n            }\n        )\n        .filter(user => (user === undefined || user === null ? false : true));\n\n    return (\n      <div className=\"app\">\n        <div\n          className=\"mainMenuChat\"\n          style={{ width: \"100%\", background: \"#eee\" }}\n        >\n          <MainMenu />\n        </div>\n        <div>\n          <h1>Welcome to Tracken Chat</h1>\n          <ul>\n            {users &&\n              users.map(user => (\n                <li key={user.id}>\n                  \n                  <button  className=\"ui button active\" onClick={() => this.startChat(user.id)}>Start Chat with Admin </button>\n                </li>\n              ))}\n          </ul>\n          \n       \n          \n        </div>\n        <div className=\"app__list\">\n        <Menu horizontal=\"true\">\n            <Dropdown item text={(this.state.currentChatUserName)} style={{\n              textAlign: \"center\"\n            }}>\n              <Dropdown.Menu>\n          {this.props.authContext.user && this.state.users && this.getChats().map(\n            chat => {\n              return (<Dropdown.Item key={chat.chatId} onClick={() => this.setState({\n                currentChatId: chat.chatId,\n                currentChatUserName: chat.userName,\n                \n              })}>{chat.userName},{moment(new Date().getTime())}</Dropdown.Item>)\n            })}\n              </Dropdown.Menu>\n            </Dropdown>\n          </Menu>\n          {this.state.currentChatId && (\n            <Form user={this.props.authContext.user} users={this.state.users} key={this.state.currentChatId} chatId={this.state.currentChatId} />\n          )}\n        </div>\n      </div>\n    );\n  }\n}\nexport default withAuth(Apps);\n"]},"metadata":{},"sourceType":"module"}